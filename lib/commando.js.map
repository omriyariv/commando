{"version":3,"file":"commando.js","sources":["../src/bounded-stack.js","../src/executer.js","../src/factory.js","../src/commands/command.js","../src/commands/set.js","../src/commands/add.js","../src/commands/remove.js","../src/commando.js"],"sourcesContent":["import _ from 'underscore';\nimport { Events } from 'backbone';\n\nconst BoundedStack = function BoundedStack(size) {\n  this.stack = [];\n  this.size = (size > 0 && size) || Number.MAX_VALUE;\n};\n\n_.extend(BoundedStack.prototype, Events, {\n\n  push(element) {\n    if (this.stack.length === this.size) {\n      this.stack.shift();\n    }\n\n    this.stack.push(element);\n\n    if (this.stack.length === 1) {\n      this.trigger('nonempty');\n    }\n\n    return element;\n  },\n\n  pop() {\n    let element;\n    if (!this.isEmpty()) {\n      element = this.stack.pop();\n      if (this.isEmpty()) {\n        this.trigger('empty');\n      }\n    }\n\n    return element;\n  },\n\n  empty() {\n    const wasEmpty = this.isEmpty();\n    this.stack = [];\n    if (!wasEmpty) {\n      this.trigger('empty');\n    }\n  },\n\n  isEmpty() {\n    return this.stack.length === 0;\n  },\n\n});\n\nexport default BoundedStack;\n","import _ from 'underscore';\nimport { Events } from 'backbone';\nimport BoundedStack from './bounded-stack';\n\nconst Executer = function Executer(levels) {\n  this.undoStack = new BoundedStack(levels);\n  this.redoStack = new BoundedStack(levels);\n  this.addListeners();\n};\n\n_.extend(Executer.prototype, Events, {\n\n  addListeners() {\n    this.undoStack.on('empty', () => this.trigger('undo:disabled'));\n    this.undoStack.on('nonempty', () => this.trigger('undo:enabled'));\n    this.redoStack.on('empty', () => this.trigger('redo:disabled'));\n    this.redoStack.on('nonempty', () => this.trigger('redo:enabled'));\n  },\n\n  do(command) {\n    command.setMode('do');\n    const ret = command.execute(...command._args);\n    if (command.register !== false) {\n      this.undoStack.push(command);\n      this.redoStack.empty();\n    }\n    this.trigger('do');\n    return ret;\n  },\n\n  undo() {\n    let ret;\n    if (this.canUndo()) {\n      const command = this.undoStack.pop();\n      command.setMode('undo');\n      ret = command.unexecute(...command._args);\n      this.redoStack.push(command);\n      this.trigger('undo');\n    }\n    return ret;\n  },\n\n  redo() {\n    let ret;\n    if (this.canRedo()) {\n      const command = this.redoStack.pop();\n      command.setMode('redo');\n      ret = command.execute(...command._args);\n      this.undoStack.push(command);\n      this.trigger('redo');\n    }\n    return ret;\n  },\n\n  canUndo() {\n    return !this.undoStack.isEmpty();\n  },\n\n  canRedo() {\n    return !this.redoStack.isEmpty();\n  },\n\n});\n\nexport default Executer;\n","import _ from 'underscore';\nimport Executer from './executer';\n\nconst Factory = function Factory() {\n  this.map = {};\n};\n\n_.extend(Factory.prototype, {\n\n  register(name, command) {\n    this.map[name] = command;\n  },\n\n  make(name, args) {\n    const Cmd = this.map[name];\n    if (Cmd) {\n      return new Cmd({\n        factory: this,\n        executer: new Executer(),\n      }, args);\n    }\n    throw new Error(`Command is not registered: ${name}`);\n  },\n\n});\n\nexport default Factory;\n","import { Events, Model } from 'backbone';\nimport _ from 'underscore';\n\nconst Command = function Command(deps, args) {\n  this._deps = deps;\n  this._args = args;\n  this.initialize.apply(this, args);\n};\n\n_.extend(Command.prototype, Events, {\n\n  register: undefined,\n\n  initialize() {},\n\n  execute() {},\n\n  unexecute() {\n    while (this._deps.executer.canUndo()) {\n      this._deps.executer.undo();\n    }\n  },\n\n  do(...args) {\n    const cmd = this._deps.factory.make(...args);\n    return this._deps.executer.do(cmd);\n  },\n\n  setMode(mode) {\n    this._mode = mode;\n  },\n\n  getMode() {\n    return this._mode;\n  },\n\n});\n\nCommand.extend = Model.extend;\n\nexport default Command;\n","import Command from './command';\nimport _ from 'underscore';\n\nconst SetCmd = Command.extend({\n\n  initialize(model) {\n    this.prevAttrs = _.clone(model.attributes);\n  },\n\n  execute(model, attrs, options) {\n    return model.set(attrs, options);\n  },\n\n  unexecute(model, attrs, options) {\n    return model.set(this.prevAttrs, options);\n  },\n\n});\n\nexport default SetCmd;\n","import Command from './command';\n\nconst AddCmd = Command.extend({\n\n  execute(collection, models, options) {\n    return collection.add(models, options);\n  },\n\n  unexecute(collection, models, options) {\n    return collection.remove(models, options);\n  },\n\n});\n\nexport default AddCmd;\n","import Command from './command';\n\nconst RemoveCmd = Command.extend({\n\n  execute(collection, models, options) {\n    return collection.remove(models, options);\n  },\n\n  unexecute(collection, models, options) {\n    return collection.add(models, options);\n  },\n\n});\n\nexport default RemoveCmd;\n","import Backbone, { Events } from 'backbone';\nimport _ from 'underscore';\nimport Factory from './factory';\nimport Executer from './executer';\nimport SetCmd from './commands/set';\nimport AddCmd from './commands/add';\nimport RemoveCmd from './commands/remove';\nimport Command from './commands/command';\n\nconst Commando = Backbone.Commando = function Commando(options) {\n  this.options = options || {};\n  this.factory = new Factory();\n  this.executer = new Executer(this.options.levels);\n  this._registerCommands();\n  this._initProxyEvents();\n};\n\n_.extend(Commando.prototype, Events, {\n\n  register(name, command) {\n    return this.factory.register(name, command);\n  },\n\n  do(...args) {\n    const cmd = this.factory.make(...args);\n    return this.executer.do(cmd);\n  },\n\n  undo(...args) {\n    return this.executer.undo(...args);\n  },\n\n  redo(...args) {\n    return this.executer.redo(...args);\n  },\n\n  canUndo() {\n    return this.executer.canUndo();\n  },\n\n  canRedo() {\n    return this.executer.canRedo();\n  },\n\n  _registerCommands() {\n    this.register('set', SetCmd);\n    this.register('add', AddCmd);\n    this.register('remove', RemoveCmd);\n  },\n\n  _initProxyEvents() {\n    this.executer.on('all', this._triggerProxyEvent, this);\n  },\n\n  _triggerProxyEvent(...args) {\n    this.trigger(...args);\n  },\n\n});\n\nCommando.Command = Command;\n\nexport default Commando;\n"],"names":["Events","Model","Backbone"],"mappings":"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"}